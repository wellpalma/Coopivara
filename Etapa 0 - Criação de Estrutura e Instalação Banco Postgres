## Criação da Estrutura - Banco Postgres ## 


-- Acesso ao Postgres
sudo -u postgres psql

-- Criação da DataBase
create database COOPIVARA;

-- Acessando a base
\c coopivara

-- Alteração do formato da data para importação
SET DATESTYLE TO PostgreSQL,Europeran;

-- Criação da tabela Associado
CREATE TABLE ASSOCIADO
(
    IDASSOCIADO integer NOT NULL,
    NOME character varying(20) NOT NULL,
	SORBENOME character varying(40) NOT NULL,
    IDADE integer NOT NULL,
    EMAIL character varying(50) NOT NULL,
    CONSTRAINT ASSOCIADO_pkey PRIMARY KEY (IDASSOCIADO)
);

-- Criação da tabela Conta
CREATE TABLE CONTA
(
    IDCONTA integer NOT NULL,
    TIPO character varying(20) NOT NULL,
	DATA_CRIACAO date NOT NULL,
	IDASSOCIADO integer NOT NULL references ASSOCIADO (IDASSOCIADO),
    CONSTRAINT CONTA_pkey PRIMARY KEY (IDCONTA)
);

-- Criação da tabela Cartão
CREATE TABLE CARTAO
(
    IDCARTAO integer NOT NULL,
	NUM_CARTAO integer NOT NULL,
	NOM_IMPRESSO character varying(20) NOT NULL,
	data_criacao_cartao date NOT NULL,
    IDCONTA integer NOT NULL references CONTA (IDCONTA),
    IDASSOCIADO integer NOT NULL references ASSOCIADO (IDASSOCIADO),
    CONSTRAINT CARTAO_pkey PRIMARY KEY (IDCARTAO)
);


-- Criação da tabela Movimento
CREATE TABLE MOVIMENTO
(
    IDMOVIMENTO integer NOT NULL,
	VLR_TRANSACAO  numeric(10,2) NOT NULL,
	DES_TRANSACAO character varying(150) NOT NULL,
	DATA_MOVIMENTO date NOT NULL,
	IDCARTAO integer NOT NULL references CARTAO (IDCARTAO),
    CONSTRAINT MOVIMENTO_pkey PRIMARY KEY (IDMOVIMENTO)
);


--INSERE DADOS TABELA ASSOCIADO
INSERT INTO ASSOCIADO (IDASSOCIADO, NOME, SORBENOME,  IDADE ,  EMAIL) VALUES (1,'Joao','Ferreira',21,'joao.ferreira@gmail.com');
INSERT INTO ASSOCIADO (IDASSOCIADO, NOME, SORBENOME,  IDADE ,  EMAIL) VALUES (2,'José','Machado',47,'jose@gmail.com');
INSERT INTO ASSOCIADO (IDASSOCIADO, NOME, SORBENOME,  IDADE ,  EMAIL) VALUES (3,'Maria','Silveira',76,'maria@gmail.com');
INSERT INTO ASSOCIADO (IDASSOCIADO, NOME, SORBENOME,  IDADE ,  EMAIL) VALUES (4,'Helena','Araujo',33,'helena@gmail.com');
INSERT INTO ASSOCIADO (IDASSOCIADO, NOME, SORBENOME,  IDADE ,  EMAIL) VALUES (5,'Davi','Vieira',40,'davi@gmail.com');



--INSERE DADOS TABELA CONTA
INSERT INTO CONTA (IDCONTA, TIPO, DATA_CRIACAO, IDASSOCIADO) VALUES (1,'Corrente','17/04/2020',1);
INSERT INTO CONTA (IDCONTA, TIPO, DATA_CRIACAO, IDASSOCIADO) VALUES (2,'Poupança','27/03/2020',1);
INSERT INTO CONTA (IDCONTA, TIPO, DATA_CRIACAO, IDASSOCIADO) VALUES (3,'Poupança','07/04/2020',2);
INSERT INTO CONTA (IDCONTA, TIPO, DATA_CRIACAO, IDASSOCIADO) VALUES (4,'Corrente','17/10/2020',3);
INSERT INTO CONTA (IDCONTA, TIPO, DATA_CRIACAO, IDASSOCIADO) VALUES (5,'Corrente','22/03/2020',4);
INSERT INTO CONTA (IDCONTA, TIPO, DATA_CRIACAO, IDASSOCIADO) VALUES (6,'Poupança','17/10/2020',3);

--INSERE DADOS TABELA CARTAO
INSERT INTO CARTAO (IDCARTAO, NUM_CARTAO, NOM_IMPRESSO,data_criacao_cartao, IDCONTA, IDASSOCIADO) VALUES (1,1020304050,'Joao Ferreira Card','24/02/2019',1,1);
INSERT INTO CARTAO (IDCARTAO, NUM_CARTAO, NOM_IMPRESSO,data_criacao_cartao, IDCONTA, IDASSOCIADO) VALUES (2,111111111,'Jose S Machado','24/02/2019',3,2);
INSERT INTO CARTAO (IDCARTAO, NUM_CARTAO, NOM_IMPRESSO,data_criacao_cartao, IDCONTA, IDASSOCIADO) VALUES (3,222222,'Maria T Silveira','04/03/2018',4,3);
INSERT INTO CARTAO (IDCARTAO, NUM_CARTAO, NOM_IMPRESSO,data_criacao_cartao, IDCONTA, IDASSOCIADO) VALUES (4,333333,'Helena N Araujo','24/02/2020',5,4);
INSERT INTO CARTAO (IDCARTAO, NUM_CARTAO, NOM_IMPRESSO,data_criacao_cartao, IDCONTA, IDASSOCIADO) VALUES (5,444444,'Joao Ferreira Card','14/05/2020',2,1);
INSERT INTO CARTAO (IDCARTAO, NUM_CARTAO, NOM_IMPRESSO,data_criacao_cartao, IDCONTA, IDASSOCIADO) VALUES (6,555555,'Joao Ferreira 2','01/01/2020',1,1);


--INSERE DADOS TABELA MOVIMENTO
INSERT INTO MOVIMENTO (IDMOVIMENTO, VLR_TRANSACAO, DES_TRANSACAO, DATA_MOVIMENTO, IDCARTAO) VALUES (1,10.99,'Coopivara','20/02/2019',1);
INSERT INTO MOVIMENTO (IDMOVIMENTO, VLR_TRANSACAO, DES_TRANSACAO, DATA_MOVIMENTO, IDCARTAO) VALUES (2,100,'Mercado','20/02/2020',2);
INSERT INTO MOVIMENTO (IDMOVIMENTO, VLR_TRANSACAO, DES_TRANSACAO, DATA_MOVIMENTO, IDCARTAO) VALUES (3,72.31,'Netflix','20/07/2019',3);
INSERT INTO MOVIMENTO (IDMOVIMENTO, VLR_TRANSACAO, DES_TRANSACAO, DATA_MOVIMENTO, IDCARTAO) VALUES (4,5.99,'Bar','20/02/2019',4);
INSERT INTO MOVIMENTO (IDMOVIMENTO, VLR_TRANSACAO, DES_TRANSACAO, DATA_MOVIMENTO, IDCARTAO) VALUES (5,99,'Ifood','12/03/2019',5);
INSERT INTO MOVIMENTO (IDMOVIMENTO, VLR_TRANSACAO, DES_TRANSACAO, DATA_MOVIMENTO, IDCARTAO) VALUES (6,12,'Uber','20/07/2020',6);
INSERT INTO MOVIMENTO (IDMOVIMENTO, VLR_TRANSACAO, DES_TRANSACAO, DATA_MOVIMENTO, IDCARTAO) VALUES (7,230.12,'99Pop','10/12/2019',1);
INSERT INTO MOVIMENTO (IDMOVIMENTO, VLR_TRANSACAO, DES_TRANSACAO, DATA_MOVIMENTO, IDCARTAO) VALUES (8,121.52,'Pedagio','13/04/2020',2);
INSERT INTO MOVIMENTO (IDMOVIMENTO, VLR_TRANSACAO, DES_TRANSACAO, DATA_MOVIMENTO, IDCARTAO) VALUES (9,1.99,'Estacionamento','28/06/2020',3);
INSERT INTO MOVIMENTO (IDMOVIMENTO, VLR_TRANSACAO, DES_TRANSACAO, DATA_MOVIMENTO, IDCARTAO) VALUES (10,22.03,'Presente','20/01/2018',4);


-- CRIAÇÃO DO SELECT PARA GERAÇÃO DA TABELA COM OS DADOS UNIFICADOS
select associado.nome,
associado.SORBENOME,
associado.idade,
movimento.vlr_transacao,
movimento.des_transacao,
movimento.data_movimento,
cartao.num_cartao,
cartao.nom_impresso,
cartao.data_criacao_cartao,
conta.tipo,
conta.data_criacao
FROM associado
LEFT JOIN conta on (conta.idassociado = associado.idassociado)
LEFT JOIN CARTAO on (CARTAO.IDCONTA = CONTA.IDCONTA)
LEFT JOIN MOVIMENTO on (MOVIMENTO.IDCARTAO = CARTAO.IDCARTAO);

-- CRIAÇÃO DE UMA VIEW COM O RESULTADO DO SELECT ACIMA
CREATE VIEW movimento_flat AS Select associado.nome,
associado.SORBENOME,
associado.idade,
movimento.vlr_transacao,
movimento.des_transacao,
movimento.data_movimento,
cartao.num_cartao,
cartao.nom_impresso,
cartao.data_criacao_cartao,
conta.tipo,
conta.data_criacao
FROM associado
LEFT JOIN conta on (conta.idassociado = associado.idassociado)
LEFT JOIN CARTAO on (CARTAO.IDCONTA = CONTA.IDCONTA)
LEFT JOIN MOVIMENTO on (MOVIMENTO.IDCARTAO = CARTAO.IDCARTAO);
